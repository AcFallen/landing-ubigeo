---
import Layout from '../layouts/Layout.astro';
import "../styles/global.css";
import Topbar from '../components/Topbar.astro';
import Sidebar from '../components/Sidebar.astro';
import IntroSection from '../components/IntroSection.astro';
import EpDepartamentos from '../components/EpDepartamentos.astro';
import EpDepartamento from '../components/EpDepartamento.astro';
import EpProvincia from '../components/EpProvincia.astro';
import EpDistrito from '../components/EpDistrito.astro';
import EpBuscar from '../components/EpBuscar.astro';
import ResponseCodes from '../components/ResponseCodes.astro';

const BASE_URL = "https://kmoxd00ic1.execute-api.us-east-1.amazonaws.com";
---

<Layout>
<div id="app" class="flex flex-col h-screen overflow-hidden">

  <Topbar />

  <div id="body-layout" class="flex flex-1 overflow-hidden">

    <!-- Backdrop para mobile -->
    <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black/45 backdrop-blur-[2px] z-399"></div>

    <Sidebar baseUrl={BASE_URL} />

    <main id="main-content" class="flex-1 overflow-y-auto bg-white">
      <IntroSection baseUrl={BASE_URL} />

      <div class="h-px bg-gray-200 mx-4 md:mx-8 lg:mx-14"></div>
      <EpDepartamentos baseUrl={BASE_URL} />

      <div class="h-px bg-gray-200 mx-4 md:mx-8 lg:mx-14"></div>
      <EpDepartamento baseUrl={BASE_URL} />

      <div class="h-px bg-gray-200 mx-4 md:mx-8 lg:mx-14"></div>
      <EpProvincia baseUrl={BASE_URL} />

      <div class="h-px bg-gray-200 mx-4 md:mx-8 lg:mx-14"></div>
      <EpDistrito baseUrl={BASE_URL} />

      <div class="h-px bg-gray-200 mx-4 md:mx-8 lg:mx-14"></div>
      <EpBuscar baseUrl={BASE_URL} />

      <div class="h-px bg-gray-200 mx-4 md:mx-8 lg:mx-14"></div>
      <ResponseCodes />
    </main>
  </div>
</div>
</Layout>

<style is:global>
  /* JSON syntax highlighting (aplicado via innerHTML por JS) */
  .j-key  { color: #79C0FF; }
  .j-str  { color: #A5D6FF; }
  .j-num  { color: #F78166; }
  .j-bool { color: #FF9E64; }
  .j-null { color: #A5D6FF; }
  .code-comment { color: #8B949E; font-style: italic; }
  .url-param, .path-param { color: #F15A24; font-style: italic; }

  /* Response status badges (JS sets className) */
  .resp-status.ok  { background: #D1FAE5; color: #065F46; }
  .resp-status.err { background: #FEE2E2; color: #991B1B; }

  /* Loading row needs flex when not hidden */
  .resp-loading:not(.hidden) { display: flex; align-items: center; }

  /* Spinner */
  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner {
    width: 16px; height: 16px;
    border: 2px solid #333; border-top-color: #F15A24;
    border-radius: 50%; animation: spin .7s linear infinite; flex-shrink: 0;
  }

  /* Scrollbar main content */
  #main-content::-webkit-scrollbar { width: 6px; }
  #main-content::-webkit-scrollbar-track { background: transparent; }
  #main-content::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 3px; }
</style>

<script is:inline define:vars={{ BASE_URL }}>
  const BASE = BASE_URL;

  function highlightJSON(json) {
    if (typeof json !== 'string') json = JSON.stringify(json, null, 2);
    return json
      .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
      .replace(
        /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
        (match) => {
          let cls = 'j-num';
          if (/^"/.test(match)) cls = /:$/.test(match) ? 'j-key' : 'j-str';
          else if (/true|false/.test(match)) cls = 'j-bool';
          else if (/null/.test(match)) cls = 'j-null';
          return `<span class="${cls}">${match}</span>`;
        }
      );
  }

  async function callAPI(id, url) {
    const panel     = document.getElementById(`resp-${id}`);
    const statusEl  = document.getElementById(`status-${id}`);
    const timeEl    = document.getElementById(`time-${id}`);
    const bodyEl    = document.getElementById(`body-${id}`);
    const loadingEl = document.getElementById(`loading-${id}`);

    panel.classList.remove('hidden');
    loadingEl.classList.remove('hidden');
    bodyEl.innerHTML = '';

    const start = Date.now();
    try {
      const res     = await fetch(url);
      const elapsed = Date.now() - start;
      const data    = await res.json();
      statusEl.textContent = `${res.status} ${res.statusText || (res.ok ? 'OK' : 'Error')}`;
      statusEl.className   = `resp-status font-bold text-xs px-2 py-0.5 rounded ${res.ok ? 'ok' : 'err'}`;
      timeEl.textContent   = `${elapsed} ms`;
      bodyEl.innerHTML     = highlightJSON(data);
    } catch (e) {
      statusEl.textContent = 'Error de red';
      statusEl.className   = 'resp-status font-bold text-xs px-2 py-0.5 rounded err';
      timeEl.textContent   = `${Date.now() - start} ms`;
      bodyEl.textContent   = e.message;
    } finally {
      loadingEl.classList.add('hidden');
    }
  }

  function updateUrl(id, url) {
    const el = document.getElementById(`url-${id}`);
    if (el) el.textContent = url;
  }

  // ── Endpoint 1: GET /departamentos ──
  document.querySelector('[data-endpoint="dep-list"]')?.addEventListener('click', () => {
    callAPI('dep-list', `${BASE}/departamentos`);
  });

  // ── Endpoint 2: GET /departamentos/{code} ──
  const depCodeInput = document.getElementById('input-dep-code');
  depCodeInput?.addEventListener('input', () => {
    updateUrl('dep-code', `${BASE}/departamentos/${depCodeInput.value.trim() || '{code}'}`);
  });
  document.querySelector('[data-endpoint="dep-code"]')?.addEventListener('click', () => {
    const v = depCodeInput?.value.trim();
    if (!v) { depCodeInput?.focus(); return; }
    callAPI('dep-code', `${BASE}/departamentos/${encodeURIComponent(v)}`);
  });

  // ── Endpoint 3: GET /provincias/{code} ──
  const provCodeInput = document.getElementById('input-prov-code');
  provCodeInput?.addEventListener('input', () => {
    updateUrl('prov-code', `${BASE}/provincias/${provCodeInput.value.trim() || '{code}'}`);
  });
  document.querySelector('[data-endpoint="prov-code"]')?.addEventListener('click', () => {
    const v = provCodeInput?.value.trim();
    if (!v) { provCodeInput?.focus(); return; }
    callAPI('prov-code', `${BASE}/provincias/${encodeURIComponent(v)}`);
  });

  // ── Endpoint 4: GET /distritos/{code} ──
  const distCodeInput = document.getElementById('input-dist-code');
  distCodeInput?.addEventListener('input', () => {
    updateUrl('dist-code', `${BASE}/distritos/${distCodeInput.value.trim() || '{code}'}`);
  });
  document.querySelector('[data-endpoint="dist-code"]')?.addEventListener('click', () => {
    const v = distCodeInput?.value.trim();
    if (!v) { distCodeInput?.focus(); return; }
    callAPI('dist-code', `${BASE}/distritos/${encodeURIComponent(v)}`);
  });

  // ── Endpoint 5: GET /buscar ──
  const buscarQ     = document.getElementById('input-buscar-q');
  const buscarLimit = document.getElementById('input-buscar-limit');
  function updateBuscarUrl() {
    const q     = buscarQ?.value.trim() || '{q}';
    const limit = buscarLimit?.value.trim();
    updateUrl('buscar', `${BASE}/buscar?q=${q}${limit ? `&limit=${limit}` : ''}`);
  }
  buscarQ?.addEventListener('input', updateBuscarUrl);
  buscarLimit?.addEventListener('input', updateBuscarUrl);
  document.querySelector('[data-endpoint="buscar"]')?.addEventListener('click', () => {
    const q = buscarQ?.value.trim();
    if (!q || q.length < 2) { buscarQ?.focus(); return; }
    const limit = buscarLimit?.value.trim();
    callAPI('buscar', `${BASE}/buscar?q=${encodeURIComponent(q)}${limit ? `&limit=${encodeURIComponent(limit)}` : ''}`);
  });

  // ── Copy buttons ──
  document.querySelectorAll('[data-copy]').forEach(btn => {
    btn.addEventListener('click', () => {
      navigator.clipboard?.writeText(btn.dataset.copy).then(() => {
        const orig = btn.innerHTML;
        btn.textContent = '✓ Copiado';
        setTimeout(() => { btn.innerHTML = orig; }, 1500);
      });
    });
  });
  document.querySelectorAll('[data-target]').forEach(btn => {
    btn.addEventListener('click', () => {
      const el = document.getElementById(btn.dataset.target);
      if (!el) return;
      navigator.clipboard?.writeText(el.textContent).then(() => {
        const orig = btn.textContent;
        btn.textContent = '✓ Copiado';
        setTimeout(() => { btn.textContent = orig; }, 1500);
      });
    });
  });

  // ── Sidebar active state ──
  const navItems = document.querySelectorAll('.nav-item[data-section]');
  const obs = new IntersectionObserver(
    (entries) => entries.forEach(e => {
      if (e.isIntersecting)
        navItems.forEach(i => i.classList.toggle('active', i.dataset.section === e.target.id));
    }),
    { rootMargin: '-20% 0px -70% 0px' }
  );
  document.querySelectorAll('[id]').forEach(s => obs.observe(s));

  navItems.forEach(item => {
    item.addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById(item.dataset.section)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      closeSidebar();
    });
  });

  // ── Mobile sidebar ──
  const sidebar  = document.getElementById('sidebar');
  const overlay  = document.getElementById('sidebar-overlay');
  const menuBtn  = document.getElementById('menu-toggle');

  function openSidebar()  { sidebar?.classList.add('open'); overlay?.classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
  function closeSidebar() { sidebar?.classList.remove('open'); overlay?.classList.add('hidden'); document.body.style.overflow = ''; }

  menuBtn?.addEventListener('click', () => sidebar?.classList.contains('open') ? closeSidebar() : openSidebar());
  overlay?.addEventListener('click', closeSidebar);
  window.addEventListener('resize', () => { if (window.innerWidth > 768) closeSidebar(); });
</script>
